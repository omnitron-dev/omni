<!DOCTYPE html>
<html>
<head>
    <title>Manual Netron Test</title>
</head>
<body>
    <h1>Manual Netron Test</h1>
    <pre id="output"></pre>

    <script type="module">
        async function log(msg) {
            const output = document.getElementById('output');
            output.textContent += msg + '\n';
            console.log(msg);
        }

        async function testConcurrent() {
            try {
                log('=== Testing Concurrent Requests ===');
                const { Netron } = await import('/netron-unified.js');

                const client = new Netron({
                    transport: 'http',
                    url: 'http://localhost:3333'
                });

                await client.connect();
                log('Connected');

                const userService = await client.queryInterface('UserService@1.0.0');
                log('Got service proxy: ' + typeof userService);
                log('Service keys: ' + Object.keys(userService));

                // Make 5 concurrent requests
                const promises = [];
                for (let i = 0; i < 5; i++) {
                    log(`Creating promise ${i}...`);
                    promises.push(userService.getUsers());
                }

                log('Waiting for all promises...');
                const results = await Promise.all(promises);

                log(`Got ${results.length} results`);
                log(`All valid: ${results.every(r => Array.isArray(r) && r.length > 0)}`);

                await client.disconnect();
                log('SUCCESS: Concurrent requests test passed');
            } catch (error) {
                log('ERROR: ' + error.message);
                log('Stack: ' + error.stack);
            }
        }

        async function testTimeout() {
            try {
                log('\n=== Testing Timeout Configuration ===');
                const { Netron } = await import('/netron-unified.js');

                const client = new Netron({
                    transport: 'http',
                    url: 'http://localhost:3333',
                    timeout: 100 // Very short timeout
                });

                await client.connect();
                log('Connected');

                const userService = await client.queryInterface('UserService@1.0.0');
                log('Got service');

                // Try to call slow method (should timeout)
                try {
                    log('Calling slow method...');
                    await userService.slowMethod();
                    log('ERROR: Should have timed out');
                } catch (error) {
                    log('Got expected error: ' + error.message);
                    log('Is timeout error: ' + (error.message.includes('timeout') || error.message.includes('abort')));
                    await client.disconnect();
                    log('SUCCESS: Timeout test passed');
                }
            } catch (error) {
                log('ERROR: ' + error.message);
                log('Stack: ' + error.stack);
            }
        }

        async function testCustomHeaders() {
            try {
                log('\n=== Testing Custom Headers ===');
                const { Netron } = await import('/netron-unified.js');

                const client = new Netron({
                    transport: 'http',
                    url: 'http://localhost:3333',
                    headers: {
                        'X-Custom-Header': 'test-value'
                    }
                });

                await client.connect();
                log('Connected');

                const userService = await client.queryInterface('UserService@1.0.0');
                const users = await userService.getUsers();

                log(`Got ${users.length} users`);

                await client.disconnect();
                log('SUCCESS: Custom headers test passed');
            } catch (error) {
                log('ERROR: ' + error.message);
                log('Stack: ' + error.stack);
            }
        }

        // Run tests
        (async () => {
            await testConcurrent();
            await testTimeout();
            await testCustomHeaders();
            log('\n=== All Tests Complete ===');
        })();
    </script>
</body>
</html>
