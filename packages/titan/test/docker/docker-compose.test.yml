services:
  redis-test:
    image: redis:7-alpine
    container_name: redis-test-${TEST_SUITE_ID:-default}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly no
      --save ""
      --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 1s
      timeout: 3s
      retries: 5
      start_period: 1s
    networks:
      - test-network
    tmpfs:
      - /data
    labels:
      - "test.suite=${TEST_SUITE_ID:-default}"
      - "test.type=redis"
      - "test.cleanup=true"

  redis-cluster-node1:
    image: redis:7-alpine
    container_name: redis-cluster-node1-${TEST_SUITE_ID:-default}
    ports:
      - "${REDIS_CLUSTER_PORT_1:-7000}:6379"
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --port 6379
    networks:
      - test-network
    labels:
      - "test.suite=${TEST_SUITE_ID:-default}"
      - "test.type=redis-cluster"
      - "test.cleanup=true"

  redis-cluster-node2:
    image: redis:7-alpine
    container_name: redis-cluster-node2-${TEST_SUITE_ID:-default}
    ports:
      - "${REDIS_CLUSTER_PORT_2:-7001}:6379"
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --port 6379
    networks:
      - test-network
    labels:
      - "test.suite=${TEST_SUITE_ID:-default}"
      - "test.type=redis-cluster"
      - "test.cleanup=true"

  redis-cluster-node3:
    image: redis:7-alpine
    container_name: redis-cluster-node3-${TEST_SUITE_ID:-default}
    ports:
      - "${REDIS_CLUSTER_PORT_3:-7002}:6379"
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --port 6379
    networks:
      - test-network
    labels:
      - "test.suite=${TEST_SUITE_ID:-default}"
      - "test.type=redis-cluster"
      - "test.cleanup=true"

networks:
  test-network:
    name: test-network-${TEST_SUITE_ID:-default}
    driver: bridge
    labels:
      - "test.suite=${TEST_SUITE_ID:-default}"
      - "test.cleanup=true"